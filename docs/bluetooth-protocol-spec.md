# 蓝牙设备通信协议规范

> **版本**: 1.0  
> **最后更新**: 2026年1月28日  
> **适用项目**: speaker-management-mini-program

## 1. 协议设计原则

### 1.1 基础格式
- **起始符**: `7E`
- **整体长度**: 1字节（表示命令码+方向+数据的总长度）
- **方向标识**: 1字节（`01`=下行，即我们发给设备；`02`=上行，即设备发给我们）
- **命令码**: 2字节（如 `02 01`）
- **数据**: 可变长度（根据具体功能）
- **结束符**: `EF`
- **完整格式**: `7E [整体长度] [方向标识] [命令码] [数据] EF`

### 1.2 命令码设计规范
- **请求命令码**: `02 XX`（功能编码）
- **响应命令码**: `02 YY`（YY = XX + 03，如 40→43, 50→53）
- **设计原因**: 明确区分请求与响应，避免循环处理错误，增强状态机清晰度
- **注意**: 实际指令格式为 `7E [整体长度] 01 [命令码] [数据] EF`（下行）或 `7E [整体长度] 02 [命令码] [数据] EF`（上行）

### 1.3 数据编码规则
- **数值类型**: 大端序（Big Endian）
- **字符串类型**: UTF-8编码
- **长度字段**: 1字节表示后续数据长度
- **布尔值**: `00`=否/关闭/禁用，`01`=是/开启/启用

---

## 2. 控制类指令

### 2.1 设备基础控制

| 功能 | 指令格式 | 说明 |
|------|----------|------|
| 恢复出厂设置 | `7E 04 01 02 01` | 04=整体长度（共4字节：02 01 02 01），01=方向（下行），02 01=命令码，无参数，简单控制指令 |
| 开关机 | `7E 05 01 02 02 01` (开机) / `7E 05 01 02 02 00` (关机) | 05=整体长度（共5字节：02 02 01 02 01），01=方向（下行），02 02=命令码，数据01=开机，00=关机 |
| 灯模式 | `7E 05 01 02 03 01` (模式1) / `7E 05 01 02 03 02` (模式2) / `7E 05 01 02 03 03` (模式3) | 05=整体长度（共5字节：02 03 01 02 03），01=方向（下行），02 03=命令码，数据表示不同灯效模式 |
| 定时开关 | `7E 05 01 02 04 01` (开启) / `7E 05 01 02 04 00` (关闭) | 05=整体长度（共5字节：02 04 01 02 04），01=方向（下行），02 04=命令码，数据01=开启，00=关闭 |
| 上电播放 | `7E 05 01 02 05 01` (开启) / `7E 05 01 02 05 00` (关闭) | 05=整体长度（共5字节：02 05 01 02 05），01=方向（下行），02 05=命令码，数据01=开启，00=关闭 |
| 到点循环 | `7E 05 01 02 06 01` (开启) / `7E 05 01 02 06 00` (关闭) | 05=整体长度（共5字节：02 06 01 02 06），01=方向（下行），02 06=命令码，数据01=开启，00=关闭 |
| 上一首 | `7E 03 01 02 07` | 03=整体长度（共3字节：02 07 01），01=方向（下行），02 07=命令码，无参数，简单控制指令 |
| 播放/停止 | `7E 03 01 02 08` | 03=整体长度（共3字节：02 08 01），01=方向（下行），02 08=命令码，无参数，简单控制指令 |
| 下一首 | `7E 03 01 02 09` | 03=整体长度（共3字节：02 09 01），01=方向（下行），02 09=命令码，无参数 |
| 音量加 | `7E 03 01 02 0A` | 03=整体长度（共3字节：02 0A 01），01=方向（下行），02 0A=命令码，无参数 |
| 音量减 | `7E 03 01 02 0B` | 03=整体长度（共3字节：02 0B 01），01=方向（下行），02 0B=命令码，无参数 |

### 2.2 状态同步

| 功能 | 指令格式 | 返回格式 | 说明 |
|------|----------|----------|------|
| 同步设备状态 | `7E 03 01 02 10` | `7E [整体长度] 02 02 11 [状态字节]` | 03=整体长度（共3字节：02 10 01），01=方向（下行），02 10=命令码，[整体长度]=整体长度（根据状态字节长度确定），02=方向（上行），02 11=响应命令码，获取设备当前状态 |
| 状态字节格式 | - | `[开关机][定时][上电播放][到点循环]` | 4字节状态信息 |

**状态字节详细说明**:
- 字节1: 开关机状态 - `00`=关机, `01`=开机
- 字节2: 定时模式 - `00`=关闭, `01`=开启
- 字节3: 上电播放 - `00`=关闭, `01`=开启  
- 字节4: 到点循环 - `00`=关闭, `01`=开启

---

## 3. 文件管理类指令

### 3.1 文件操作

| 功能 | 指令格式 | 返回格式 | 说明 |
|------|----------|----------|------|
| 读取文件列表 | `7E 03 01 02 30` | `7E [整体长度] 02 02 31 [文件数据]` (文件1) / `7E [整体长度] 02 02 31 [文件数据]` (文件2) / ... / `7E 03 02 02 32` (结束) | 03=整体长度（共3字节：02 30 01），01=方向（下行），02 30=命令码，[整体长度]=整体长度（根据文件数据长度确定），02=方向（上行），02 31=响应命令码，02 32=结束命令码，逐个返回文件数据后以结束指令结尾 |
| 删除文件 | `7E 04 01 02 32 [ID]` | `7E 05 02 02 33 [结果]` (成功) / `7E 05 02 02 33 [结果]` (失败) | 04=整体长度（共4字节：02 32 01 [ID]），01=方向（下行），02 32=命令码，05=整体长度（共5字节：02 33 02 [结果]），02=方向（上行），02 33=响应命令码，删除指定ID的文件 |
| 发送LED文字 | `7E [整体长度] 01 02 20 [长度] [文字]` | - | [整体长度]=整体长度（根据[长度]和[文字]总字节数确定），01=方向（下行），02 20=命令码，发送UTF-8编码文字到LED屏幕 |

**文件信息格式**: `[ID][名称长度][名称][大小]`
- ID: 1字节
- 名称长度: 1字节
- 名称: UTF-8编码字符串
- 大小: 4字节（KB单位，大端序）

### 3.2 文件传输（支持MTU协商）

#### 传输流程
1. **开始传输及文件信息**: `7E [整体长度] 01 02 33 [ID长度] [ID] [大小]` (下行)
2. **数据分包**: 使用 `writeCommandToDeviceWithSplit` 分包发送（≤20字节/包）
3. **结束传输**: `7E 03 01 02 35` (下行)
4. **确认结果**: `7E [整体长度] 02 02 36 [结果]` (上行) (`01`=成功, `00`=失败)

#### MTU协商优化
- 支持BLE 4.2+设备的MTU协商
- 协商成功后可使用更大分包尺寸（最高128字节）
- 协商失败自动回退到20字节默认值

---

## 4. 任务管理类指令

### 4.1 定时任务管理

| 功能 | 指令格式 | 返回格式 | 说明 |
|------|----------|----------|------|
| 更新定时任务 | `7E [整体长度] 01 02 40 [任务数据]` | `7E [整体长度] 02 02 41 [结果]` (成功) / `7E [整体长度] 02 02 41 [结果]` (失败) | [整体长度]=整体长度（根据任务数据字节数确定），01=方向（下行），02 40=命令码，[整体长度]=整体长度（根据结果字节数确定），02=方向（上行），02 41=响应命令码，更新单个任务 |
| 获取定时任务 | `7E 03 01 02 42` | `7E [整体长度] 02 02 43 [任务数据]` (任务1) / `7E [整体长度] 02 02 43 [任务数据]` (任务2) / ... / `7E 03 02 02 44` (结束) | 03=整体长度（共3字节：02 42 01），01=方向（下行），02 42=命令码，[整体长度]=整体长度（根据任务数据字节数确定），02=方向（上行），02 43=响应命令码，02 44=结束命令码，逐个返回任务数据后以结束指令结尾 |

**任务数据格式**: `[ID长度][ID][文件ID][音量][继电器][开始时间][结束时间][星期几][启用状态]`
- ID长度: 1字节
- ID: 可变长度（对应前端task.id）
- 文件ID: 1字节
- 音量: 1字节（0-30）
- 继电器: 1字节（00=关, 01=开）
- 开始时间: 2字节（分钟数，从00:00开始）
- 结束时间: 2字节（同上）
- 星期几: 1字节（位掩码，bit0-6分别表示周日到周六，如 0x7F 表示每天都播放）
- 启用状态: 1字节（00=禁用, 01=启用）

### 4.2 循环播放任务管理

| 功能 | 指令格式 | 返回格式 | 说明 |
|------|----------|----------|------|
| 更新循环任务 | `7E [整体长度] 01 02 50 [任务数据]` | `7E [整体长度] 02 02 51 [结果]` (成功) / `7E [整体长度] 02 02 51 [结果]` (失败) | [整体长度]=整体长度（根据任务数据字节数确定），01=方向（下行），02 50=命令码，[整体长度]=整体长度（根据结果字节数确定），02=方向（上行），02 51=响应命令码，更新单个循环任务 |
| 获取循环任务 | `7E 03 01 02 51` | `7E [整体长度] 02 02 52 [任务数据]` (任务1) / `7E [整体长度] 02 02 52 [任务数据]` (任务2) / ... / `7E 03 02 02 53` (结束) | 03=整体长度（共3字节：02 51 01），01=方向（下行），02 51=命令码，[整体长度]=整体长度（根据任务数据字节数确定），02=方向（上行），02 52=响应命令码，02 53=结束命令码，逐个返回任务数据后以结束指令结尾 |

**循环任务数据格式**: `[ID长度][ID][文件ID][音量][继电器][间隔时间][启用状态]`
- ID长度: 1字节
- ID: 可变长度（对应前端task.id）
- 文件ID: 1字节
- 音量