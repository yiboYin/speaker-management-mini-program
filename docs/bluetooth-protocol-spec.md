# 蓝牙设备通信协议规范

> **版本**: 1.0  
> **最后更新**: 2026年1月28日  
> **适用项目**: speaker-management-mini-program

## 1. 协议设计原则

### 1.1 基础格式
- **起始符**: `7E`
- **命令码**: 2字节（如 `02 01`）
- **数据**: 可变长度（根据具体功能）
- **结束符**: `EF`
- **完整格式**: `7E [命令码] [数据] EF`

### 1.2 命令码设计规范
- **请求命令码**: `02 XX`（功能编码）
- **响应命令码**: `02 YY`（YY = XX + 03，如 40→43, 50→53）
- **设计原因**: 明确区分请求与响应，避免循环处理错误，增强状态机清晰度

### 1.3 数据编码规则
- **数值类型**: 大端序（Big Endian）
- **字符串类型**: UTF-8编码
- **长度字段**: 1字节表示后续数据长度
- **布尔值**: `00`=否/关闭/禁用，`01`=是/开启/启用

---

## 2. 控制类指令

### 2.1 设备基础控制

| 功能 | 指令格式 | 说明 |
|------|----------|------|
| 恢复出厂设置 | `7E 02 01 EF` | 无参数，简单控制指令 |
| 开关机 | `7E 02 02 01 EF` (开机) / `7E 02 02 00 EF` (关机) | 数据01=开机，00=关机 |
| 灯模式 | `7E 02 03 01 EF` (模式1) / `7E 02 03 02 EF` (模式2) / `7E 02 03 03 EF` (模式3) | 数据表示不同灯效模式 |
| 定时开关 | `7E 02 04 01 EF` (开启) / `7E 02 04 00 EF` (关闭) | 数据01=开启，00=关闭 |
| 上电播放 | `7E 02 05 01 EF` (开启) / `7E 02 05 00 EF` (关闭) | 数据01=开启，00=关闭 |
| 到点循环 | `7E 02 06 01 EF` (开启) / `7E 02 06 00 EF` (关闭) | 数据01=开启，00=关闭 |
| 上一首 | `7E 02 07 EF` | 无参数，简单控制指令 |
| 播放/停止 | `7E 02 08 EF` | 无参数，简单控制指令 |
| 下一首 | `7E 02 09 EF` | 无参数 |
| 音量加 | `7E 02 0A EF` | 无参数 |
| 音量减 | `7E 02 0B EF` | 无参数 |

### 2.2 状态同步

| 功能 | 指令格式 | 返回格式 | 说明 |
|------|----------|----------|------|
| 同步设备状态 | `7E 02 10 EF` | `7E 02 11 [状态字节] EF` | 获取设备当前状态 |
| 状态字节格式 | - | `[开关机][定时][上电播放][到点循环]` | 4字节状态信息 |

**状态字节详细说明**:
- 字节1: 开关机状态 - `00`=关机, `01`=开机
- 字节2: 定时模式 - `00`=关闭, `01`=开启
- 字节3: 上电播放 - `00`=关闭, `01`=开启  
- 字节4: 到点循环 - `00`=关闭, `01`=开启

---

## 3. 文件管理类指令

### 3.1 文件操作

| 功能 | 指令格式 | 返回格式 | 说明 |
|------|----------|----------|------|
| 读取文件列表 | `7E 02 30 EF` | `7E 02 31 [数量] [文件1] [文件2]... EF` | 获取所有文件信息 |
| 删除文件 | `7E 02 32 [ID] EF` | `7E 02 33 01 EF` (成功) / `7E 02 33 00 EF` (失败) | 删除指定ID的文件 |
| 发送LED文字 | `7E 02 20 [长度] [文字] EF` | - | 发送UTF-8编码文字到LED屏幕 |

**文件信息格式**: `[ID][名称长度][名称][大小]`
- ID: 1字节
- 名称长度: 1字节
- 名称: UTF-8编码字符串
- 大小: 4字节（KB单位，大端序）

### 3.2 文件传输（支持MTU协商）

#### 传输流程
1. **开始传输**: `7E 02 33 EF`
2. **文件信息**: `7E 02 34 [ID长度] [ID] [大小] EF`
3. **数据分包**: 使用 `writeCommandToDeviceWithSplit` 分包发送（≤20字节/包）
4. **结束传输**: `7E 02 35 EF`
5. **确认结果**: `7E 02 36 [结果] EF` (`01`=成功, `00`=失败)

#### MTU协商优化
- 支持BLE 4.2+设备的MTU协商
- 协商成功后可使用更大分包尺寸（最高128字节）
- 协商失败自动回退到20字节默认值

---

## 4. 任务管理类指令

### 4.1 定时任务管理

| 功能 | 指令格式 | 返回格式 | 说明 |
|------|----------|----------|------|
| 批量更新定时任务 | `7E 02 40 [数量] [任务1] [任务2]... EF` | `7E 02 43 01 EF` (成功) / `7E 02 43 00 EF` (失败) | 一次性更新多个任务 |
| 获取定时任务 | `7E 02 42 EF` | `7E 02 43 [数量] [任务1] [任务2]... EF` | 获取所有定时任务 |

**任务数据格式**: `[ID长度][ID][文件ID][音量][继电器][开始时间][结束时间][启用状态]`
- ID长度: 1字节
- ID: 可变长度（对应前端task.id）
- 文件ID: 1字节
- 音量: 1字节（0-30）
- 继电器: 1字节（00=关, 01=开）
- 开始时间: 2字节（分钟数，从00:00开始）
- 结束时间: 2字节（同上）
- 启用状态: 1字节（00=禁用, 01=启用）

### 4.2 循环播放任务管理

| 功能 | 指令格式 | 返回格式 | 说明 |
|------|----------|----------|------|
| 更新循环任务 | `7E 02 50 [数量] [任务1] [任务2]... EF` | `7E 02 53 01 EF` (成功) / `7E 02 53 00 EF` (失败) | 一次性更新多个循环任务 |
| 获取循环任务 | `7E 02 51 EF` | `7E 02 52 [数量] [任务1] [任务2]... EF` | 获取所有循环任务 |

**循环任务数据格式**: `[ID长度][ID][文件ID][音量][继电器][间隔时间][启用状态]`
- ID长度: 1字节
- ID: 可变长度（对应前端task.id）
- 文件ID: 1字节
- 音量